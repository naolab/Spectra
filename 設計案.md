# AIスクリーン共有エージェント 設計案（v1.0）

---

# 1. 全体アーキテクチャ（概要）

本システムは以下の3層アーキテクチャで構築する。

[Electron GUI] ← OS共通
↓
[MCPサーバー (Node.js)] ← OS共通
↓ 子プロセス呼び出し
[Capture Layer（macOS = Swift, 他OS = ネイティブ）] ← OS依存

yaml
コードをコピーする

---

# 2. 使用技術スタック（確定）

## 2.1 GUI
- **Electron**
- React または Svelte（軽量なら Svelte）
- OS共通で動作
- settings.json を作成/編集する役割

## 2.2 MCP サーバー
- **Node.js + TypeScript**
- "model-context-protocol" npm ライブラリ
- stdout/stdin を用いたRPC通信
- capture, settings, list_windows APIを提供

## 2.3 macOSキャプチャ層（v1）
- **Swift**
- CoreGraphics / Quartz API
- `CGWindowListCreateImage`
- `CGDisplayCreateImage`
- Accelerate.framework（高速画像処理）
- 出力は JPEG/WebP

## 2.4 Windows（将来拡張）
- C++ or Rust
- DXGI OutputDuplication API

## 2.5 Linux（将来拡張）
- C++ / Rust
- X11: XShmGetImage
- Wayland: PipeWire

## 2.6 設定保存
- settings.json（Electron側で保存）

---

# 3. モジュール構成

/project-root
├── gui/ # Electron GUI
│ ├── src/
│ ├── public/
│ └── package.json
│
├── mcp-server/ # Node.js MCPサーバー
│ ├── src/
│ ├── package.json
│ └── mcp-schema.json
│
├── capture/
│ ├── mac/ # Swiftキャプチャ
│ │ ├── Sources/
│ │ └── Package.swift
│ ├── win/ # C++/Rustキャプチャ（v2）
│ └── linux/ # Linuxキャプチャ（v3）
│
└── settings.json

yaml
コードをコピーする

---

# 4. データフロー

## 4.1 ユーザー操作 → GUI → MCP → キャプチャ → AI

例：「画面共有みて」

AI → MCP（screen.capture_latest）
MCP → Swiftキャプチャをspawn
Swift → JPEG/WebPバッファ返却
MCP → AIへ返却
AI → 解析結果をユーザーに返す

yaml
コードをコピーする

---

# 5. MCP API設計

### screen.capture_latest()
- settings.json に基づき画面をキャプチャ
- 成功時：`{ type: "image", data: <base64> }`

### screen.list_windows()
- macOSの場合 Swift側でウィンドウ一覧取得

### screen.capture_window(windowId)
- 指定 ID のウィンドウをキャプチャ

### screen.capture_region(x, y, w, h)
- 指定領域だけ切り抜き

### settings.get() / settings.set()
- GUIとAIどちらからも設定操作可能

---

# 6. settings.json 仕様

```json
{
  "target": {
    "type": "window",
    "windowId": 12345
  },
  "region": null
}
将来：

複数ウィンドウ対応

自動選択（AIが list_windows から推測）

7. キャプチャ層（macOS）仕様
7.1 ウィンドウ一覧
CGWindowListCopyWindowInfo を使用
必要情報：

kCGWindowOwnerName

kCGWindowNumber

Bounds

7.2 ウィンドウキャプチャ
CGWindowListCreateImage

特定 windowID のみキャプチャ可能

非アクティブウィンドウもOK

最小化ウィンドウは不可（仕様）

7.3 ディスプレイキャプチャ
CGDisplayCreateImage(mainDisplayID)

7.4 埋め込みフォーマット
JPEG（品質80〜90）

WebP（推奨）

8. GUI 機能仕様（Electron）
画面1：ウィンドウ選択画面
macOS の全ウィンドウ一覧を表示（MCP経由）

クリックで選択 → settings.json に保存

画面2：ディスプレイ選択
画面3：任意領域選択画面
画面を半透明オーバーレイ

ドラッグして矩形選択

Electronでは別ウィンドウを透明にして実現可能

画面4：権限設定ガイド
macOS Security & Privacy → Screen Recording

権限がない場合案内を表示

9. プロセス構成
csharp
コードをコピーする
[Electron(main)]
    ↓ IPC
[MCP Server(Node)]
    ↓ spawn
[Swift capture process]
※ macOS, Windows, Linux すべて同じパターンで構成できる。

10. v1 スコープ（macOS）
必須：

ウィンドウキャプチャ

ディスプレイキャプチャ

設定GUI

MCPサーバー

AIとの接続（GPT/Claude）

オプション：

領域キャプチャ

自動ウィンドウ判定

WebP最適化

11. v2（Windows版）のための設計上の配慮
Capture層を完全別モジュールとして実装

MCP側には OS非依存の抽象APIを提供

settings.json でOSを問わず指定できる構造

GUIのウィンドウ一覧機能はOS別にMCP側が返す

12. v3（Linux対応）
X11 / Wayland の違いを抽象化

Linuxユーザー向けの権限対応（PipeWire）

yaml
コードをコピーする

---